name: Build
on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build32:
    name: 32-bit build
    runs-on: ubuntu-latest
    outputs:
      artifact_name: love2dxp-x86
    container: 
      image: i386/alpine:3.22
      volumes:
        - /tmp:/__e/node20_alpine
    steps:
      # Fix checkout and upload-artifact to use local alternatives as the shipped node version is for another architecture
      - name: Fix checkout and upload-artifact
        run: apk update && apk add nodejs && mkdir -p /__e/node20_alpine/bin && ln -s $(which node) /__e/node20_alpine/bin/node && ln -s $(which npm) /__e/node20_alpine/bin/npm && ln -s $(which npx) /__e/node20_alpine/bin/npx

      - name: Setup
        #env:
        #  DEBIAN_FRONTEND: non-interactive
        #run: "sudo apt update && sudo apt install -y build-essential make gcc gcc-multilib g++ mingw-w64 binutils-mingw-w64 mingw-w64-common mingw-w64-tools mingw-w64-i686-dev mingw-w64-x86-64-dev zip"
        run: "apk update && apk add cmake make gcc g++ musl-dev linux-headers mingw-w64-binutils mingw-w64-crt mingw-w64-gcc mingw-w64-gcc-ccache mingw-w64-headers mingw-w64-headers-doc mingw-w64-winpthreads mingw-w64-winpthreads-doc"

      - name: Checkout source
        uses: actions/checkout@v4

      #- name: Get CMake
      #  uses: lukka/get-cmake@latest
      #  with:
      #    cmakeVersion: 3.30.5

      - name: Prepare build
        run: cmake -B build -DCMAKE_TOOLCHAIN_FILE="mingw32.cmake"

      - name: "Build love"
        run: "cmake --build build --target love --config Release --parallel 2"

      - name: "Build lovec"
        run: "cmake --build build --target lovec --config Release --parallel 2"

      - name: "Prepackage"
        run: "mkdir ship && cp build/love/*.dll ship/ && cp build/love/*.exe ship/ && cp build/bin/*.dll ship/ && cp build/SDL2/*.dll ship/ && cp build/mpg123/*.dll ship/ && cp build/openal-soft/*.dll ship/ && cp /usr/i686-w64-mingw32/bin/libgcc_s_dw2-1.dll ship/ && cp /usr/i686-w64-mingw32/bin/libstdc++-6.dll ship/ && cp /usr/i686-w64-mingw32/bin/libwinpthread-1.dll ship/"

      - name: "Publish artifact"
        uses: actions/upload-artifact@v4
        with:
          path: ship
          name: love2dxp-x86
          retention-days: 2
          compression-level: 9
  build64:
    name: 64-bit build
    runs-on: ubuntu-latest
    outputs:
      artifact_name: love2dxp-x64
    container: amd64/alpine:3.22
    steps:
      - name: Setup
        #env:
        #  DEBIAN_FRONTEND: non-interactive
        #run: "sudo apt update && sudo apt install -y build-essential make gcc gcc-multilib g++ mingw-w64 binutils-mingw-w64 mingw-w64-common mingw-w64-tools mingw-w64-i686-dev mingw-w64-x86-64-dev zip"
        run: apk update && apk add cmake make gcc g++ musl-dev linux-headers mingw-w64-binutils mingw-w64-crt mingw-w64-gcc mingw-w64-gcc-ccache mingw-w64-headers mingw-w64-headers-doc mingw-w64-winpthreads mingw-w64-winpthreads-doc

      - name: Checkout source
        uses: actions/checkout@v4

      #- name: Get CMake
      #  uses: lukka/get-cmake@latest
      #  with:
      #    cmakeVersion: 3.30.5

      - name: Prepare build
        run: cmake -B build -DCMAKE_TOOLCHAIN_FILE="mingw64.cmake"

      - name: "Build love"
        run: "cmake --build build --target love --config Release --parallel 2"

      - name: "Build lovec"
        run: "cmake --build build --target lovec --config Release --parallel 2"

      - name: "Prepackage"
        run: "mkdir ship && cp build/love/*.dll ship/ && cp build/love/*.exe ship/ && cp build/bin/*.dll ship/ && cp build/SDL2/*.dll ship/ && cp build/mpg123/*.dll ship/ && cp build/openal-soft/*.dll ship/ && cp /usr/x86_64-w64-mingw32/bin/libgcc_s_seh-1.dll ship/ && cp /usr/x86_64-w64-mingw32/bin/libstdc++-6.dll ship/ && cp /usr/x86_64-w64-mingw32/bin/libwinpthread-1.dll ship/"

      - name: "Publish artifact"
        uses: actions/upload-artifact@v4
        with:
          path: ship
          name: love2dxp-x64
          retention-days: 2
          compression-level: 9
  release:
    name: Create new release
    permissions: write-all
    needs: [build32, build64]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Download 32-bit artifact
        id: artifact_download32
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build32.outputs.artifact_name }}

      - name: Download 64-bit artifact
        id: artifact_download64
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build64.outputs.artifact_name }}

      #- name: Parse version
      #  id: parsed_version
      #  run: |
      #      #!/bin/bash
      #      echo "version=${GITHUB_REF//'refs/heads/v'/}" >> $GITHUB_OUTPUT
      #  shell: bash

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Upload 32-bit asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ github.workspace }}
          asset_name: love2dxp-x86.zip
          asset_content_type: application/zip

      - name: Upload 64-bit asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ github.workspace }}
          asset_name: love2dxp-x64.zip
          asset_content_type: application/zip